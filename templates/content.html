<p>Copy this link into your Podcast App: <a href="./rss/{{ .playlist_id }}">RSS-Feed</a></p>
<form hx-post="/audio" hx-target="#audio-list" hx-target-error="#popup-container">
    <fieldset>
        <legend>Add Media</legend>
        <label for="media_url">URL</label>
        <input type="url" id="media_url" name="media_url" placeholder="https://www.youtube.com/watch?v=rMqfD2vInLo"
            required>
        <button type="submit" hx-indicator="#indicator">Add Media</button>
    </fieldset>
</form>

<h2>Playlist <span class="playlist-name">{{ .playlist_name }}</span></h2>
<div id="audio-list">
    {{ template "itemlist.html" . }}
</div>

<h2>Events</h2>
<ul id="items"></ul>

<script>
    const evtSource = new EventSource("/events");

    evtSource.onmessage = function (e) {
        try { data = JSON.parse(e.data); }
        catch { return console.warn("Invalid SSE message", e.data); }
        const id = data.id;
        let item = document.querySelector(`.item[data-id='${id}']`);

        if (!item) {
            item = document.createElement('details');
            item.className = 'item';
            item.dataset.id = id;

            item.innerHTML = `
                <summary>
                    <strong>${data.id}</strong>
                    <span class="progress">${data.progress}%</span>
                    <span class="status">${data.status}</span>
                </summary>
                <div><strong>Title:</strong> <span class="title">${data.title || "N/A"}</span></div>
                <div><strong>Source:</strong> <span class="source">${data.source_url || "N/A"}</span></div>
            `;
            // Add new item to the top of the list
            const itemsList = document.getElementById('items');
            itemsList.prepend(item);
            // Fade in
            item.style.opacity = 0;
            requestAnimationFrame(() => item.style.transition = 'opacity 0.5s');
            requestAnimationFrame(() => item.style.opacity = 1);
        } else {
            // Update existing item
            item.querySelector(".progress").textContent = data.progress + "%";
            item.querySelector(".status").textContent = data.status;
            item.querySelector(".title").textContent = data.title;
            item.querySelector(".source").textContent = data.source_url;
            if (data.done) {
                item.querySelector(".status").textContent = "✅ Done";
            }
            if (data.error && data.error !== "") {
                item.querySelector(".status").textContent = "❌ " + data.error;
            }
        }
    };
</script>
